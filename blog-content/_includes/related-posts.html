<div class="related-posts" style="margin-top: 48px; padding-top: 32px; border-top: 2px solid #e9ecef;">
  <h3 style="color: #1e3a5f; margin-bottom: 24px; font-size: 1.5em; text-align: center;">
    Related Articles You May Like
  </h3>
  
  <div class="related-posts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
    {% assign maxRelated = 3 %}
    {% assign minCommonTags = 1 %}
    {% assign maxRelatedCounter = 0 %}
    
    {% for post in site.posts %}
      {% assign sameTagCount = 0 %}
      {% assign commonTags = '' %}
      
      {% for tag in post.tags %}
        {% if post.url != page.url %}
          {% if page.tags contains tag %}
            {% assign sameTagCount = sameTagCount | plus: 1 %}
            {% capture tagmarkup %} <span class="related-tag">{{ tag }}</span> {% endcapture %}
            {% assign commonTags = commonTags | append: tagmarkup %}
          {% endif %}
        {% endif %}
      {% endfor %}
      
      {% if sameTagCount >= minCommonTags %}
        {% if maxRelatedCounter < maxRelated %}
          {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
          <a href="{{ post.url | relative_url }}" class="related-post-card" 
             style="display: block; background: #f8f9fa; border-radius: 12px; padding: 20px; text-decoration: none; color: inherit; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #e9ecef;"
             data-testid="link-related-post-{{ maxRelatedCounter }}">
            <h4 style="color: #1e3a5f; margin-bottom: 8px; font-size: 1.1em; line-height: 1.4;">
              {{ post.title }}
            </h4>
            <p style="color: #666; font-size: 0.85em; margin-bottom: 12px; line-height: 1.5;">
              {{ post.excerpt | strip_html | truncate: 100 }}
            </p>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8em;">
              <span style="color: #888;">{{ post.date | date: "%b %d, %Y" }}</span>
              <span style="color: #ffd700; font-weight: bold;">Read More →</span>
            </div>
          </a>
        {% endif %}
      {% endif %}
    {% endfor %}
    
    {% if maxRelatedCounter == 0 %}
      {% for post in site.posts limit: 3 %}
        {% if post.url != page.url %}
          <a href="{{ post.url | relative_url }}" class="related-post-card" 
             style="display: block; background: #f8f9fa; border-radius: 12px; padding: 20px; text-decoration: none; color: inherit; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #e9ecef;"
             data-testid="link-recent-post-{{ forloop.index }}">
            <h4 style="color: #1e3a5f; margin-bottom: 8px; font-size: 1.1em; line-height: 1.4;">
              {{ post.title }}
            </h4>
            <p style="color: #666; font-size: 0.85em; margin-bottom: 12px; line-height: 1.5;">
              {{ post.excerpt | strip_html | truncate: 100 }}
            </p>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8em;">
              <span style="color: #888;">{{ post.date | date: "%b %d, %Y" }}</span>
              <span style="color: #ffd700; font-weight: bold;">Read More →</span>
            </div>
          </a>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>
  
  <div style="text-align: center; margin-top: 24px;">
    <a href="{{ '/posts/' | relative_url }}" 
       style="display: inline-block; background: #1e3a5f; color: white; padding: 12px 32px; border-radius: 8px; text-decoration: none; font-weight: bold;"
       data-testid="link-view-all-posts">
      View All Articles
    </a>
  </div>
</div>

<style>
  .related-post-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }
  .related-tag {
    background: #e3f2fd;
    color: #1e3a5f;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75em;
    margin-right: 4px;
  }
</style>
